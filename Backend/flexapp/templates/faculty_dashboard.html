{% load static %}
<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link
			rel="stylesheet"
			href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
		/>
		<link rel="stylesheet" href="{% static 'css/faculty.min.css' %}" />
		<title>Dashboard</title>
		<style>
			select, option, .option	{
				    padding: .5rem .7rem;
    margin: 10px 0;
    font-size: 16px;
    outline: none;
    border-radius: 10px;
    border: 1px solid #f1c40f;
    background-color: rgba(0, 0, 0, 0);
    color: #f5f5f5;
			}
			option:hover{
				    padding: .5rem .7rem;
    margin: 10px 0;
    font-size: 16px;
    outline: none;
    border-radius: 10px;
    border: 1px solid #f1c40f;
    background-color: rgba(0, 0, 0, 0);
    color: #f5f5f5;
			}
			
			/* Advanced Filters Block Styling */
			.advanced-filters-container {
				width: 100%;
				margin: 20px 0;
				padding: 0 20px;
			}
			
			#advanced-filters {
				background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
				border: 2px solid #f1c40f;
				border-radius: 15px;
				padding: 25px;
				margin: 0 auto;
				max-width: 1200px;
				box-shadow: 0 8px 25px rgba(241, 196, 15, 0.2);
				transition: all 0.3s ease-in-out;
				opacity: 0;
				max-height: 0;
				overflow: hidden;
				transform: translateY(-10px);
			}
			
			#advanced-filters.show {
				opacity: 1;
				max-height: 800px;
				transform: translateY(0);
			}
			
			#advanced-filters h3 {
				color: #f1c40f;
				margin-bottom: 20px;
				font-size: 1.4em;
				text-align: center;
				border-bottom: 2px solid #f1c40f;
				padding-bottom: 15px;
			}
			
			.advanced-filter-grid {
				display: grid;
				grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
				gap: 20px;
				margin-top: 20px;
			}
			
			.filter-group {
				display: flex;
				flex-direction: column;
			}
			
			.filter-group label {
				color: #f1c40f;
				font-weight: 600;
				margin-bottom: 8px;
				font-size: 0.95em;
			}
			
			#advancedToggle {
				background: linear-gradient(135deg, #f1c40f, #e67e22);
				border: none;
				color: #1a1a1a;
				padding: 12px 20px;
				border-radius: 10px;
				font-weight: bold;
				cursor: pointer;
				transition: all 0.3s ease;
				margin-bottom: 15px;
				width: 100%;
				position: relative;
				overflow: hidden;
			}
			
			#advancedToggle:hover {
				background: linear-gradient(135deg, #e67e22, #f1c40f);
				transform: translateY(-2px);
				box-shadow: 0 5px 15px rgba(241, 196, 15, 0.4);
			}
			
			#advancedToggle.active {
				background: linear-gradient(135deg, #e74c3c, #c0392b);
				color: white;
			}
			
			#advancedToggle i {
				margin-right: 8px;
				transition: transform 0.3s ease;
			}
			
			#advancedToggle.active i {
				transform: rotate(180deg);
			}
			
			#clearAdvancedFilters {
				background: linear-gradient(135deg, #e74c3c, #c0392b) !important;
				color: white !important;
				border: none !important;
				padding: 12px 24px !important;
				border-radius: 8px !important;
				cursor: pointer !important;
				transition: all 0.3s ease !important;
				font-weight: 600 !important;
				margin-top: 15px !important;
				font-size: 1rem !important;
			}
			
			#clearAdvancedFilters:hover {
				background: linear-gradient(135deg, #c0392b, #a93226) !important;
				transform: translateY(-1px) !important;
				box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3) !important;
			}
			main{
				flex-direction: row;
			}
			.advanced-filters-container{
				margin: 0;
				padding: 0;
			}
			#advanced-filters{
				margin: 0;
				padding: 0;
			}
			.open-container{
				    width: 100%;
    margin: 20px 0 !important;
    padding: 0 20px;
			}
			.open{
				    padding: 25px !important;
    margin: 0 auto;
			}
		</style>
	</head>

	<body>
		<header>
			<img src="{% static 'img/logo.png' %}" alt="Profile Image" />
			<div class="title">
				<h1>MITS - FLEX</h1>
			</div>
		</header>

		<main>
			<div class="left-bar">
				<aside class="filters">
					<h2>Search and Filter</h2>
					<hr />
					
					<!-- Basic Filters Section -->
					<div class="basic-filters">
						<input
							type="search"
							name="student-search"
							id="student-search"
							placeholder="Search by Roll Number or Name"
						/>
						
						<label for="student-year">Year:</label>
						<div class="radio-group">
							<div class="radio">
								<input type="radio" name="year" id="year-1" />
								<label for="year-1">1</label>
							</div>
							<div class="radio">
								<input type="radio" name="year" id="year-2" />
								<label for="year-2">2</label>
							</div>
							<div class="radio">
								<input type="radio" name="year" id="year-3" />
								<label for="year-3">3</label>
							</div>
							<div class="radio">
								<input type="radio" name="year" id="year-4" />
								<label for="year-4">4</label>
							</div>
						</div>
						
						<label for="student-section">Section:</label>
						<div class="radio-group">
							<div class="radio">
								<input type="radio" name="section" id="section-a" />
								<label for="section-a">A</label>
							</div>
							<div class="radio">
								<input type="radio" name="section" id="section-b" />
								<label for="section-b">B</label>
							</div>
							<div class="radio">
								<input type="radio" name="section" id="section-c" />
								<label for="section-c">C</label>
							</div>
							<div class="radio">
								<input type="radio" name="section" id="section-d" />
								<label for="section-d">D</label>
							</div>
						</div>
						
						<div class="button-group">
							<button><i class="bi bi-search"></i> Search</button>
							<button class="reset">
								<i class="bi bi-arrow-clockwise"></i> Reset
							</button>
						</div>
					</div>
					
					<!-- Advanced Filters Toggle Button -->
					<button id="advancedToggle">
						<i class="bi bi-sliders"></i> Advanced Filters
					</button>
				</aside>
				<br />
				<button onclick="return downloadData()">Download</button>
			</div>
			<div class="right-bar">
			<!-- Advanced Filters Section Above Table -->
			<div class="advanced-filters-container">
				<!-- Advanced Filters Block -->
				<div id="advanced-filters">
					<h3><i class="bi bi-funnel"></i> Advanced Filters</h3>
					
					<div class="advanced-filter-grid">
						<div class="filter-group">
							<label for="leetcode-problems">LeetCode Problems:</label>
							<input
								type="number"
								id="leetcode-problems"
								name="leetcode-problems"
								placeholder="Min problems solved"
							/>
						</div>
						
						<div class="filter-group">
							<label for="projects">Projects:</label>
							<input
								type="number"
								id="projects"
								name="projects"
								placeholder="Min projects done"
							/>
						</div>
						
						<div class="filter-group">
							<label for="certifications">Certifications:</label>
							<input
								type="number"
								id="certifications"
								name="certifications"
								placeholder="Min certifications"
							/>
						</div>
						
						<div class="filter-group">
							<label for="certificate-provider">Certificate Provider:</label>
							<select id="certificate-provider" name="certificate-provider">
								<option value="">All Providers</option>
								{% for provider in certificate_providers %}
									<option value="{{ provider }}">{{ provider }}</option>
								{% endfor %}
							</select>
						</div>
						
						<div class="filter-group">
							<label for="technology">Technology:</label>
							<select id="technology" name="technology">
								<option value="">All Technologies</option>
								{% for tech in technologies %}
									<option value="{{ tech }}">{{ tech }}</option>
								{% endfor %}
							</select>
						</div>
						
						<div class="filter-group">
							<label for="domain">Domain:</label>
							<select id="domain" name="domain">
								<option value="">All Domains</option>
								{% for domain in domains %}
									<option value="{{ domain }}">{{ domain }}</option>
								{% endfor %}
							</select>
						</div>
						
						<div class="filter-group">
							<label for="certificate-category">Certificate Category:</label>
							<select id="certificate-category" name="certificate-category">
								<option value="">All Categories</option>
								{% for category in certificate_categories %}
									<option value="{{ category }}">{{ category|title }}</option>
								{% endfor %}
							</select>
						</div>
						
						<div class="filter-group">
							<label for="project-status">Project Status:</label>
							<select id="project-status" name="project-status">
								<option value="">All Statuses</option>
								{% for status in project_statuses %}
									<option value="{{ status }}">{{ status|title }}</option>
								{% endfor %}
							</select>
						</div>
						
						<div class="filter-group">
							<label for="mentor">Mentor:</label>
							<select id="mentor" name="mentor">
								<option value="">All Mentors</option>
								{% for mentor in mentors %}
									<option value="{{ mentor }}">{{ mentor }}</option>
								{% endfor %}
							</select>
						</div>
						
						<div class="filter-group">
							<label for="department">Department:</label>
							<select id="department" name="department">
								<option value="">All Departments</option>
								{% for dept in departments %}
									<option value="{{ dept }}">{{ dept }}</option>
								{% endfor %}
							</select>
						</div>
					</div>
					
					<div style="margin-top: 15px; text-align: center;">
						<button id="clearAdvancedFilters" style="background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">
							<i class="bi bi-x-circle"></i> Clear Advanced Filters
						</button>
					</div>
				</div>
			</div>
			
			<div class="table">
				<table>
					<thead>
						<tr>
							<th>
								<input
									type="checkbox"
									name="select-all"
									id="select-all"
								/>
							</th>
							<th>S no.</th>
							<th>Roll Number</th>
							<th>Name</th>
							<th style="text-align: center">Year</th>
							<th style="text-align: center">Section</th>
							<th style="text-align: center">Dept</th>
							<th style="text-align: center">Leetcode Count</th>
							<th style="text-align: center">Projects</th>
							<th style="text-align: center">Certifications</th>
							<th style="text-align: center">Mentor</th>
						</tr>
					</thead>
					<tbody></tbody>
				</table>
			</div>
			</div>
		</main>
		<div class="form-check-label">
			<button id="themeToggle"><i class="bi bi-moon-fill"></i></button>
			<button id="FormToggle"><i class="bi bi-book-fill"></i></button>
			<button id="Gear"><i class="bi bi-gear"></i></button>
			<button id="logout"><i class="bi bi-box-arrow-right"></i></button>
		</div>
		<script>
			var None = 0;
			var studentData = {{ studentData | safe }}
			
			// Enhanced Advanced Filters Toggle
			document.getElementById('advancedToggle').addEventListener('click', () => {
				const advancedFilters = document.getElementById('advanced-filters');
				const toggleButton = document.getElementById('advancedToggle');
				
				if (advancedFilters.classList.contains('show')) {
					// Hide advanced filters
					advancedFilters.classList.remove('show');
					toggleButton.classList.remove('active');
					advancedFilters.classList.remove('open')
					document.getElementById('advanced-filters-container').classList.remove('open-container');
					toggleButton.innerHTML = '<i class="bi bi-sliders"></i> Advanced Filters';
				} else {
					// Show advanced filters
					advancedFilters.classList.add('show');
					toggleButton.classList.add('active');
					advancedFilters.classList.add('open');
					document.getElementById('advanced-filters-container').classList.add('open-container');
					toggleButton.innerHTML = '<i class="bi bi-funnel-fill"></i> Hide Advanced Filters';
				}
			});

			document.addEventListener('DOMContentLoaded', function () {
				document.querySelector("input[name='select-all']").addEventListener('change', (event) => {
					const checkboxes = document.querySelectorAll("input[name='select-student']");
					checkboxes.forEach((checkbox) => (checkbox.checked = event.target.checked));
				});
				function filterAndDisplayData() {
					const rollno = document.getElementById('student-search').value.trim().toLowerCase();
					const year = document.querySelector('input[name="year"]:checked')?.nextElementSibling.textContent.trim().toLowerCase() || "";
					const section = document.querySelector('input[name="section"]:checked')?.nextElementSibling.textContent.trim().toLowerCase() || "";
					const leetCodeProblems = parseInt(document.getElementById('leetcode-problems').value) || 0;
					const projects = parseInt(document.getElementById('projects').value) || 0;
					const certifications = parseInt(document.getElementById('certifications').value) || 0;
					const certificateProvider = document.getElementById('certificate-provider').value.trim();
					const technology = document.getElementById('technology').value.trim();
					const domain = document.getElementById('domain').value.trim();
					const certificateCategory = document.getElementById('certificate-category').value.trim();
					const projectStatus = document.getElementById('project-status').value.trim();
					const mentor = document.getElementById('mentor').value.trim();
					const department = document.getElementById('department').value.trim();

					let filteredData = studentData;
					console.log(filteredData)

					if (rollno !== "") {
						filteredData = filteredData.filter(student => student.roll_no.toLowerCase().includes(rollno) || student.first_name.toLowerCase().includes(rollno));
					}

					if (year != "") {
						filteredData = filteredData.filter(student => student.year == year);
					}

					if (section !== "") {
						filteredData = filteredData.filter(student => student.section.toLowerCase() === section);
					}

					if (leetCodeProblems > 0) {
						filteredData = filteredData.filter(student => student.studentrollno__TotalProblems >= leetCodeProblems);
					}

					if (projects > 0) {
						filteredData = filteredData.filter(student => student.project_count >= projects);
					}

					if (certifications > 0) {
						filteredData = filteredData.filter(student => student.certificate_count >= certifications);
					}

					if (certificateProvider !== "") {
						filteredData = filteredData.filter(student => 
							student.certificate_providers && student.certificate_providers.includes(certificateProvider)
						);
					}
					
					if (technology !== "") {
						filteredData = filteredData.filter(student => 
							student.technologies && student.technologies.includes(technology)
						);
					}
					
					if (domain !== "") {
						filteredData = filteredData.filter(student => 
							student.domains && student.domains.includes(domain)
						);
					}
					
					if (certificateCategory !== "") {
						filteredData = filteredData.filter(student => 
							student.certificate_categories && student.certificate_categories.includes(certificateCategory)
						);
					}
					
					if (projectStatus !== "") {
						filteredData = filteredData.filter(student => 
							student.project_statuses && student.project_statuses.includes(projectStatus)
						);
					}
					
					if (mentor !== "") {
						filteredData = filteredData.filter(student => 
							student.mentor__first_name === mentor
						);
					}
					
					if (department !== "") {
						filteredData = filteredData.filter(student => student.dept === department);
					}
					

					displayData(filteredData);
				}

				function displayData(data) {
					const tableBody = document.querySelector('tbody');
					tableBody.innerHTML = "";

					if (data.length === 0) {
						tableBody.innerHTML = `<tr><td colspan="11">No data available</td></tr>`;
						return;
					}

					data.forEach((student, index) => {
						const row = document.createElement('tr');
						row.innerHTML = `
						<td><input type="checkbox" name="select-student" value="${student.roll_no}"></td>
							<td>${index + 1}</td>
							<td>${student.roll_no}</td>
							<td>${student.first_name}</td>
							<td style='text-align: center;'>${student.year}</td>
							<td style='text-align: center;'>${student.section}</td>
							<td style='text-align: center;'>${student.dept}</td>
							<td style='text-align: center;'>${student.studentrollno__TotalProblems || 0}</td>
							<td style='text-align: center;'>${student.project_count}</td>
							<td style='text-align: center;'>${student.certificate_count}</td>
							<td style='text-align: center;'>${student.mentor__first_name || 'N/A'}</td>
						`;
						tableBody.appendChild(row);
					});
					document.querySelectorAll('td:not(:has(input))').forEach(data => {
						data.addEventListener('click', () => {
							window.location.href = '/student/' + data.parentElement.children[2].innerText;
						});
					});
				}

				function reset() {
					// Reset all form fields
					document.getElementById('student-search').value = "";
					document.querySelectorAll('input[name="year"]').forEach((radio) => (radio.checked = false));
					document.querySelectorAll('input[name="section"]').forEach((radio) => (radio.checked = false));
					document.getElementById('leetcode-problems').value = "";
					document.getElementById('projects').value = "";
					document.getElementById('certifications').value = "";
					document.getElementById('certificate-provider').value = "";
					document.getElementById('technology').value = "";
					document.getElementById('domain').value = "";
					document.getElementById('certificate-category').value = "";
					document.getElementById('project-status').value = "";
					document.getElementById('mentor').value = "";
					document.getElementById('department').value = "";
					
					// Close advanced filters panel
					const advancedFilters = document.getElementById('advanced-filters');
					const toggleButton = document.getElementById('advancedToggle');
					advancedFilters.classList.remove('show');
					toggleButton.classList.remove('active');
					toggleButton.innerHTML = '<i class="bi bi-sliders"></i> Advanced Filters';
					
					// Reset display
					displayData(studentData);
				}

				document.getElementById('student-search').addEventListener('input', filterAndDisplayData);
				document.querySelectorAll('input[name="year"], input[name="section"]').forEach((radio) => {
					radio.addEventListener('change', filterAndDisplayData);
				});
				document.getElementById('leetcode-problems').addEventListener('input', filterAndDisplayData);
				document.getElementById('projects').addEventListener('input', filterAndDisplayData);
				document.getElementById('certifications').addEventListener('input', filterAndDisplayData);
				document.getElementById('certificate-provider').addEventListener('change', filterAndDisplayData);
				document.getElementById('technology').addEventListener('change', filterAndDisplayData);
				document.getElementById('domain').addEventListener('change', filterAndDisplayData);
				document.getElementById('certificate-category').addEventListener('change', filterAndDisplayData);
				document.getElementById('project-status').addEventListener('change', filterAndDisplayData);
				document.getElementById('mentor').addEventListener('change', filterAndDisplayData);
				document.getElementById('department').addEventListener('change', filterAndDisplayData);

				const resetButton = document.querySelector('.reset');
				resetButton.addEventListener('click', reset);
				
				// Clear Advanced Filters button functionality
				document.getElementById('clearAdvancedFilters').addEventListener('click', function() {
					// Clear only advanced filter fields
					document.getElementById('leetcode-problems').value = "";
					document.getElementById('projects').value = "";
					document.getElementById('certifications').value = "";
					document.getElementById('certificate-provider').value = "";
					document.getElementById('technology').value = "";
					document.getElementById('domain').value = "";
					document.getElementById('certificate-category').value = "";
					document.getElementById('project-status').value = "";
					document.getElementById('mentor').value = "";
					document.getElementById('department').value = "";
					
					// Re-apply filters
					filterAndDisplayData();
				});

				displayData(studentData);
			});

			function downloadData() {
				const data = Array.from(document.querySelectorAll('input[name="select-student"]:checked')).map((checkbox) => checkbox.value);
				console.log(data);
				fetch("{% url 'download' %}", {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'X-CSRFToken': '{{ csrf_token }}',
					},
					body: JSON.stringify(data),
				})
					.then((response) => response.blob())
					.then((blob) => {
						const url = window.URL.createObjectURL(blob);
						const a = document.createElement('a');
						a.href = url;
						a.download = 'data.xlsx';
						document.body.appendChild(a);
						a.click();
						a.remove();
					});
			}
			document.querySelector('#FormToggle').addEventListener('click', () => {
				fetch("{% url 'fillout' %}", {
					method: 'GET',
					headers: {
						'Content-Type': 'application/json',
					},
				})
					.then((response) => {
						if (response.ok) {
							window.location.href = "{% url 'fillout' %}";
						} else {
							throw new Error('Network response was not ok');
						}
					})
					.catch((error) => {
						console.error('Error:', error);
					});
			});
			document.querySelector('#logout').addEventListener('click', () => {
				fetch("{% url 'logout' %}", {
					method: 'GET',
					headers: {
						'Content-Type': 'application/json',
					},
				})
					.then((response) => {
						if (response.ok) {
							window.location.href = "{% url 'login' %}";
						} else {
							throw new Error('Network response was not ok');
						}
					})
					.catch((error) => {
						console.error('Error:', error);
					});
					});

					const toggleSwitch = document.getElementById("themeToggle");
			const icon = document.querySelector("#themeToggle i");
			const body = document.body;
			const allElements = document.querySelectorAll("*"); // Select all elements
			console.log(allElements);
			const blur = document.querySelector(".blur");
			toggleSwitch.addEventListener("click", () => {
				// Toggle the light theme class on the body
				const formAll = document.querySelectorAll(
					"input, select, textarea, option, p, button"
				);
				body.classList.toggle("light-theme");

				// Add or remove the light theme class from all elements
				allElements.forEach((element) => {
					element.classList.toggle(
						"light-theme",
						body.classList.contains("light-theme")
					);
				});

				formAll.forEach((element) => {
					element.classList.toggle(
						"light-theme",
						body.classList.contains("light-theme")
					);
				});
				icon.classList.toggle("bi-moon-fill");
				icon.classList.toggle("bi-brightness-high-fill");
			});
		</script>
	</body>
</html>
