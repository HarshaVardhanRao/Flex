{% extends 'base.html' %}
{% block content %}
<div class="container mt-5">
  <h2 class="mb-4">FlexOn Natural Language Query Dashboard</h2>
  <form id="flexon-form" method="post">
    {% csrf_token %}
    <div class="input-group mb-3">
      <input type="text" class="form-control" name="query" placeholder="Type your query (e.g. 'students with more than 2 Python projects')" required>
      <button class="btn btn-primary" type="submit">Ask</button>
    </div>
  </form>
  <div id="clarification" class="alert alert-warning d-none"></div>

  <!-- Results Table -->
  <div id="results">
    {% if results %}
      <div class="table-responsive">
        <table class="table table-bordered table-striped">
          <thead class="table-dark">
            <tr>
              {% for key, value in results.0.items %}
                {% if key not in 'password,is_superuser,is_staff,is_active' %}
                  <th>{{ key|title }}</th>
                {% endif %}
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for record in results %}
              <tr>
                {% for key, value in record.items %}
                  {% if key not in 'password,is_superuser,is_staff,is_active' %}
                    <td>{{ value }}</td>
                  {% endif %}
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="alert alert-info">No results found.</div>
    {% endif %}
  </div>

  <div id="chart-container" class="mt-4"></div>
  <div id="export-buttons" class="mt-3 {% if not results %}d-none{% endif %}">
    <button class="btn btn-outline-secondary" id="export-csv">Export CSV</button>
    <button class="btn btn-outline-secondary" id="export-xlsx">Export Excel</button>
    <button class="btn btn-outline-secondary" id="export-pdf">Export PDF</button>
  </div>

  <div class="mt-4">
    <h5>Quick Actions</h5>
    <button class="btn btn-info quick-query" data-query="Top 10 students by LeetCode problems solved">Top 10 LeetCode</button>
    <button class="btn btn-info quick-query" data-query="Students with more than 1 placement offer">Multiple Offers</button>
    <button class="btn btn-info quick-query" data-query="Students with Cloud-related certifications">Cloud Certs</button>
    <button class="btn btn-info quick-query" data-query="Placed vs Not Placed (by Department)">Placement Stats</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const form = document.getElementById('flexon-form');
form.onsubmit = function(e) {
  e.preventDefault();
  const query = form.query.value;
  fetch('', {
    method: 'POST',
    headers: {'X-CSRFToken': form.csrfmiddlewaretoken.value},
    body: new URLSearchParams({query})
  })
  .then(r => r.json())
  .then(data => {
    document.getElementById('clarification').classList.toggle('d-none', !data.clarification);
    document.getElementById('clarification').textContent = data.clarification || '';
    renderResults(data);
  });
};

for (const btn of document.querySelectorAll('.quick-query')) {
  btn.onclick = () => {
    form.query.value = btn.dataset.query;
    form.onsubmit(new Event('submit'));
  };
}

function renderResults(data) {
  const resultsDiv = document.getElementById('results');
  if (!data.results || !data.results.length) {
    resultsDiv.innerHTML = '<div class="alert alert-info">No results found.</div>';
    document.getElementById('export-buttons').classList.add('d-none');
    document.getElementById('chart-container').innerHTML = '';
    return;
  }

  const excludeKeys = ['password', 'is_superuser', 'is_staff', 'is_active'];

  // Build dynamic table
  let html = '<div class="table-responsive"><table class="table table-bordered table-striped"><thead class="table-dark"><tr>';
  Object.keys(data.results[0]).forEach(key => {
    if (!excludeKeys.includes(key)) {
      html += `<th>${key}</th>`;
    }
  });
  html += '</tr></thead><tbody>';

  data.results.forEach(record => {
    html += '<tr>';
    Object.entries(record).forEach(([key, value]) => {
      if (!excludeKeys.includes(key)) {
        html += `<td>${value}</td>`;
      }
    });
    html += '</tr>';
  });

  html += '</tbody></table></div>';
  resultsDiv.innerHTML = html;
  document.getElementById('export-buttons').classList.remove('d-none');

  if (data.chart) {
    document.getElementById('chart-container').innerHTML = '<canvas id="flexon-chart"></canvas>';
    new Chart(document.getElementById('flexon-chart'), data.chart);
  } else {
    document.getElementById('chart-container').innerHTML = '';
  }
}
</script>
{% endblock %}
