{% extends 'base.html' %}

{% block title %}Create Form - MITS FLEX{% endblock %}

{% block content %}
<div class="section">
	<h2>Create a New Form</h2>
	<hr />
	<form method="POST">
		{% csrf_token %}

		<div class="form-section">
			<label>Form Title:</label>
			<input type="text" name="title" required />

			<label>Description:</label>
			<textarea name="description" rows="3"></textarea>

			<h3>Assign to Students</h3>

			<!-- Filters -->
			<div class="filter-section">
				<div class="filter-row">
					<div class="filter-item">
						<label>Department:</label>
						<select id="filter-department" onchange="filterStudents()">
							<option value="">-- All --</option>
							{% for dept in student.DEPT_CHOICES %}
							<option value="{{ dept.0 }}">{{ dept.0 }}</option>
							{% endfor %}
						</select>
					</div>

					<div class="filter-item">
						<label>Year:</label>
						<select id="filter-year" onchange="filterStudents()">
							<option value="">-- All --</option>
							{% for y in years %}
							<option value="{{ y }}">{{ y }}</option>
							{% endfor %}
						</select>
					</div>

					<div class="filter-item">
						<label>Section:</label>
						<select id="filter-section" onchange="filterStudents()">
							<option value="">-- All --</option>
							{% for s in sections %}
							<option value="{{ s }}">{{ s }}</option>
							{% endfor %}
						</select>
					</div>

					<div class="filter-item">
						<label>Mentees Only:</label>
						<input
							type="checkbox"
							id="filter-mentees"
							onchange="filterStudents()"
						/>
					</div>
				</div>
			</div>

			<!-- Student Checkbox List -->
			<div id="student-list" class="student-list">
				<p>Select students:</p>
				<div id="students-container" class="multiple"></div>
			</div>
		</div>

		<div class="section">
			<h3>Form Fields</h3>
			<hr />
			<div id="fields-container"></div>
			<button type="button" onclick="addField()">
				<i class="bi bi-plus"></i>
				Add Field
			</button>
		</div>

		<div style="text-align: center; margin-top: 2rem;">
			<input type="submit" value="Create Form" />
		</div>
	</form>
</div>
{% endblock %}

{% block extra_head %}
<style>
	.form-section {
		margin-bottom: 2rem;
	}

	.filter-section {
		background-color: rgba(241, 196, 15, 0.1);
		padding: 1rem;
		border-radius: 8px;
		margin: 1rem 0;
	}

	.filter-row {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
		gap: 1rem;
		align-items: end;
	}

	.filter-item {
		display: flex;
		flex-direction: column;
	}

	.filter-item label {
		margin-bottom: 0.5rem;
		color: #f1c40f;
		font-weight: 500;
	}

	.light-theme .filter-section {
		background-color: rgba(243, 156, 18, 0.1);
	}

	.light-theme .filter-item label {
		color: #f39c12;
	}

	.student-list {
		margin-top: 1rem;
	}

	.student-list p {
		font-weight: bold;
		color: #f1c40f;
		margin-bottom: 0.5rem;
	}

	.light-theme .student-list p {
		color: #f39c12;
	}

	.field-block {
		background-color: rgba(241, 196, 15, 0.1);
		padding: 1.5rem;
		margin-bottom: 1rem;
		border-radius: 8px;
		border: 1px solid rgba(241, 196, 15, 0.3);
	}

	.light-theme .field-block {
		background-color: rgba(243, 156, 18, 0.1);
		border-color: rgba(243, 156, 18, 0.3);
	}

	.field-block label {
		display: block;
		margin-bottom: 0.5rem;
		margin-top: 1rem;
		color: #f1c40f;
		font-weight: 500;
	}

	.light-theme .field-block label {
		color: #f39c12;
	}

	.field-block:first-of-type label:first-of-type {
		margin-top: 0;
	}

	#students-container label {
		display: flex;
		align-items: center;
		gap: 0.5rem;
		padding: 0.5rem;
		margin: 0.25rem 0;
		background-color: rgba(241, 196, 15, 0.05);
		border-radius: 5px;
		cursor: pointer;
		transition: background-color 0.2s ease;
	}

	#students-container label:hover {
		background-color: rgba(241, 196, 15, 0.15);
	}

	.light-theme #students-container label {
		background-color: rgba(243, 156, 18, 0.05);
	}

	.light-theme #students-container label:hover {
		background-color: rgba(243, 156, 18, 0.15);
	}

	#students-container input[type="checkbox"] {
		margin: 0;
		width: auto;
	}
</style>
{% endblock %}

{% block extra_scripts %}
<script>
	let fieldCount = 0;

	function addField() {
		const container = document.getElementById("fields-container");

		const fieldHtml = `
	<div class="field-block">
	  <label>Field Name:</label>
	  <input type="text" name="fields[${fieldCount}][field_name]" required>

	  <label>Field Type:</label>
	  <select name="fields[${fieldCount}][field_type]" onchange="onFieldTypeChange(this, ${fieldCount})" required>
		<option value="">-- Select Type --</option>
		<option value="text">Text</option>
		<option value="number">Number</option>
		<option value="date">Date</option>
		<option value="choice">Multiple Choice</option>
		<option value="file_awk">Pick Certificate or Upload File</option>
	  </select>

	  <div id="options-${fieldCount}" style="display: none;">
		<label>Options (comma separated):</label>
		<input type="text" name="fields[${fieldCount}][options]">
	  </div>

	  <div id="related-model-${fieldCount}" style="display: none;">
		<label>Related Model:</label>
		<select name="fields[${fieldCount}][related_model]">
		  <option value="">-- Select Model --</option>
		  <option value="certificate">Certificate</option>
		  <option value="project">Project</option>
		</select>
	  </div>
	</div>
  `;

		container.insertAdjacentHTML("beforeend", fieldHtml);
		fieldCount++;
	}

	function onFieldTypeChange(selectElem, index) {
		const selectedType = selectElem.value;
		document.getElementById(`options-${index}`).style.display =
			selectedType === "choice" ? "block" : "none";
		document.getElementById(
			`related-model-${index}`
		).style.display =
			selectedType === "file_awk" ? "block" : "none";
	}

	const currentFacultyId = {{ request.user.id }};
	const allStudents = [
	  {% for s in students %}
		{
		  id: {{ s.id }},
		  name: "{{ s.first_name }} {{ s.last_name }}",
		  dept: "{{ s.dept }}",
		  year: "{{ s.year }}",
		  section: "{{ s.section }}",
		},
	  {% endfor %}
	];

	function filterStudents() {
	  const dept = document.getElementById("filter-department").value;
	  const year = document.getElementById("filter-year").value;
	  const section = document.getElementById("filter-section").value;

	  const container = document.getElementById("students-container");
	  container.innerHTML = "";

	  const filtered = allStudents.filter(s => {
		return (!dept || s.dept === dept) &&
			   (!year || s.year.toString() === year) &&
			   (!section || s.section === section);
	  });

	  if (filtered.length === 0) {
		container.innerHTML = "<em>No students match your filters.</em>";
	  } else {
		filtered.forEach(s => {
		  container.innerHTML += `
			<label>
			  <input type="checkbox" name="assigned_students" value="${s.id}">
			  ${s.name} (${s.dept}, Year ${s.year}, Section ${s.section})
			</label>
		  `;
		});
	  }
	}

	// Load all students initially
	window.onload = filterStudents;
</script>
{% endblock %}
